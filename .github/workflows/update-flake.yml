name: Update Flake Inputs

on:
  schedule:
    # 每天凌晨 2 点自动运行
    - cron: '0 2 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Update flake inputs
        run: nix flake update

      - name: Check if flake.lock changed
        id: check-changes
        run: |
          if git diff --quiet flake.lock; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Build configuration
        if: steps.check-changes.outputs.changed == 'true'
        run: |
          nix build .#nixosConfigurations.nixos.config.system.build.toplevel \
            --print-build-logs \
            --keep-going

      - name: Create Pull Request
        if: steps.check-changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update flake inputs"
          title: "chore: update flake inputs"
          body: |
            ## Automated Flake Update

            This PR updates the flake.lock file with the latest versions of all inputs.

            ### Changes
            - Updated nixpkgs and other flake inputs
            - Build check passed ✅

            Please review and merge if everything looks good.
          branch: update-flake-inputs
          delete-branch: true
          labels: dependencies,automated
